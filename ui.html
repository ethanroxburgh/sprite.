<div class="was-plugin layout--column layout--justify height--stretch">
    <div class="was-plugin__body height--stretch">
        <div class="margin__bottom--125">
            <div class="form-label">Target Method</div>
            <div class="width--stretch layout--row layout--justify margin__bottom--25">
                <button class="choice target-choice width--stretch margin__right--25" id="target-key" onclick="selectTargetMethod('target-key')">Key</button>
                <button class="choice target-choice width--stretch" id="target-selection" onclick="selectTargetMethod('target-selection')">Selection</button>
            </div>
            <input class="input key-input width--stretch" placeholder="e.g. <icons>" oninput="updateTargetKey(event)">
        </div>
        <div class="margin__bottom--125">
            <div class="form-label">Icon Colour</div>
            <div class="width--stretch layout--row layout--justify margin__bottom--25">
                <button class="choice colour-choice width--stretch margin__right--25" id="colour-inherit" onclick="selectColour('colour-inherit')">Inherit</button>
                <button class="choice colour-choice width--stretch margin__right--25" id="colour-custom" onclick="selectColour('colour-custom')">Custom</button>
            </div>
            <input class="input custom-input width--stretch" placeholder="e.g. #333333" oninput="updateColour(event)">
        </div>

        <div class="form-label">Exported SVG Element</div>
        <textarea placeholder="SVG string" class="textarea width--stretch" id="svg-text"></textarea>
    </div>
    <div class="was-plugin__footer">
        <div class="was-plugin__footer-body">
            <div class="alert" id="alert">Message</div>
            <button class="button width--stretch" id="run" onclick="initiateRun()">Run</button>
        </div>
    </div>
</div>

<script>
const textDecoder = new TextDecoder('utf-8');
const domParser  = new DOMParser();
const colourInherit = 'currentcolor'

const TARGET_METHOD = {
    key: 'target-key',
    selection: 'target-selection'
};

const COLOUR_METHOD = {
    inherit: 'colour-inherit',
    custom: 'colour-custom',
};

const ALERT_MESSAGES = {
    [TARGET_METHOD.key]: 'Please provide a key',
    [COLOUR_METHOD.custom]: 'Please provide a colour',
}

let targetMethod = TARGET_METHOD.key;
let colourMethod = COLOUR_METHOD.inherit;

let svgNodeElements = [];
let identifierKey = '';
let colour = colourInherit;
let loading = false;

const runButton = document.getElementById('run');
const alertElement = document.getElementById('alert');

function validate() {
    const validTarget = targetMethod !== TARGET_METHOD.key || !!identifierKey;
    const validColour = colourMethod !== COLOUR_METHOD.custom || !!colour;
    const invalid = !validTarget || !validColour;

    return {
        invalid,
        target: validTarget,
        colour: validColour
    }
}

function showAlert(message) {
    alertElement.innerHTML = message;
    alertElement.classList.add('visibility--visible');

    setTimeout(() => {
        alertElement.classList.remove('visibility--visible');
    }, 5000)
}

function initiateRun() {
    svgNodeElements = [];

    const {
        target,
        colour,
        invalid
    } = validate();

    if (!!loading) {
        return;
    }

    if (invalid) {
        const message = !target
            ? ALERT_MESSAGES[TARGET_METHOD.key]
            : ALERT_MESSAGES[COLOUR_METHOD.custom];


        return showAlert(message);
    }

    runButton.innerHTML = 'Loading...';
    loading = true;
    parent.postMessage({
        pluginMessage: {
            event: 'run-export',
            identifierKey,
            colour
        }
    }, '*');
}

function updateTargetKey(event /* HTMLevent */) {
    identifierKey = event.srcElement.value;
}

function updateColour(event  /* HTMLevent */) {
    colour = event.srcElement.value;
}

function selectChoice(choiceClass /* string */, choiceId /* string */) {
    const choices = document.querySelectorAll(choiceClass);
    const selectedElement = document.getElementById(choiceId);

    choices.forEach(choice => choice.classList.remove('choice--active'));
    selectedElement.classList.add('choice--active');
}

function selectTargetMethod(targetId /* string */) {
    const keyInput = document.querySelector('.key-input');

    selectChoice('.target-choice', targetId)
    targetMethod = targetId;

    targetId === TARGET_METHOD.key
        ? keyInput.classList.add('visibility--visible')
        : keyInput.classList.remove('visibility--visible');
}

function selectColour(colourId /* string */) {
    const customInput = document.querySelector('.custom-input');

    selectChoice('.colour-choice', colourId);
    colourMethod = colourId;

    if (colourId === COLOUR_METHOD.custom) {
        colour = '';
        customInput.classList.add('visibility--visible');
        return;
    }

    colour = colourInherit;
    customInput.classList.remove('visibility--visible');
}

function prepSpriteElement(encodedSvg /* unit8array */, name /* string */) {
    const decodedText = textDecoder.decode(encodedSvg).replace(/[\n\t]/g, "");
    const splitNode = decodedText.split('><');
    const targetNodeIndex = splitNode.findIndex(item => item.includes('svg'));

    const filteredNode = [...splitNode].filter((item, index) =>
        index > targetNodeIndex
        && index < (splitNode.length - (targetNodeIndex + 1))
    ).map(item => {
        const nodeString = `<${item}>`;

        if (!nodeString.includes('<path')) {
            return nodeString;
        }

        const domEl = domParser.parseFromString(nodeString, "image/svg+xml").documentElement;

        if (!!domEl.getAttribute('fill')) {
            domEl.setAttribute('fill', colour);
        }

        if (!!domEl.getAttribute('fill')) {
            domEl.setAttribute('stroke', colour);
        }

        return domEl.outerHTML;
    });

    const symbolName = name.replace(identifierKey, '').replace(' ', '');
    console.log(filteredNode)

    svgNodeElements.push(`<symbol id="${symbolName}" viewBox="0 0 24 24">${filteredNode.join('')}</symbol>`);
}

function sendSprite() {
    const svgEl = document.getElementById('svg-text');
    const svg = [
        '<svg aria-hidden="true" style="position:absolute;width:0;height:0" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" overflow="hidden"><defs>',
        ...svgNodeElements,
        '</defs></svg>'
    ].join('');

    setTimeout(() => {
        svgEl.value = svgNodeElements.length === 0 ? 'Error' : svg;
        loading = false;
        runButton.innerHTML = 'Run';
    }, 200);
}

selectTargetMethod(targetMethod);
selectColour(colourMethod);

onmessage = ({ data }) => {
    const messageData = data.pluginMessage;

    if (messageData.event === 'error') {
        showAlert(messageData.message);
        loading = false;
        runButton.innerHTML = 'Run';
    }

    if (messageData.event === 'prep-sprite-el') {
        prepSpriteElement(messageData.encodedSvg, messageData.name);
    }

    if (messageData.event === 'send-sprite') {
        sendSprite();
    }
}

</script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap');

    :root {
        --font__family: 'Inter', sans-serif;
        --font__size: 13px;
        --font__weight: 300;
        --font__weight--medium: 400;
        --fond__weight--heavy: 500;

        --spacing__25: 0.25rem;
        --spacing__60: 0.6rem;
        --spacing__75: 0.75rem;
        --spacing__100: 1rem;
        --spacing__125: 1.25rem;

        --border__radius: 6px;
        --border__weight: 1px;
        --border__colour: black;
        --border__colour--light: #E6E6E6;

        --colour--primary: black;
        --colour--secondary: white;
        --colour--placeholder: #CCCCCC;
        --colour--error: #e95858;
    }

    body,
    .input,
    .button,
    .textarea,
    .choice {
        font-family: var(--font__family);
        font-size: var(--font__size);
        font-weight: var(--font__weight);
        margin: 0;
    }


    .was-plugin__body,
    .was-plugin__footer-body {
        padding: var(--spacing__125);
    }

    .was-plugin__body {
        padding-bottom: 6.5rem;
    }

    .was-plugin__footer {
        position: fixed;
        bottom: 0;
        width: 100%;
        background-color: var(--colour--secondary);
        border-top: var(--border__weight) solid var(--border__colour--light);
    }

    .height--stretch {
        height: 100%;
    }

    .width--stretch {
        width: 100%;
    }

    .layout--column {
        display: flex;
        flex-direction: column;
    }

    .layout--row {
        display: flex;
        flex-direction: row;
    }

    .layout--justify {
        justify-content: space-between;
    }

    .layout-body {
        padding: var(--spacing__);
    }

    .layout-footer {
        padding: var(--spacing__100);
        border-top: var(----border__weight) solid var(--colour--placeholder);
    }

    .visibility--visible {
        display: block !important;
    }

    .margin__right--25 {
        margin-right: var(--spacing__25);
    }

    .margin__bottom--25 {
        margin-bottom: var(--spacing__25);
    }

    .margin__bottom--125 {
        margin-bottom: var(--spacing__125);
    }

    .input {
        border: var(--border__weight) solid var(--colour--primary);
        padding: var(--spacing__60);
        border-radius: var(--border__radius);
        outline: none;
        display: none;
        font-size: 12px;
    }

    .input--invalid {
        border-color: var(--colour--error);
    }

    .textarea {
        height: 5.5rem;
        max-height: 8rem;
        border: var(--border__weight) solid var(--colour--primary);
        border-radius: var(--border__radius);
        padding: var(--spacing__75);
        outline: none;
        resize: vertical;
    }

    .input::placeholder,
    .textarea::placeholder {
        color: var(--colour--placeholder);
    }

    .form-label {
        font-weight: var(--fond__weight--heavy);
        margin-bottom: var(--spacing__60);
    }

    .button {
        background-color: var(--colour--primary);
        color: var(--colour--secondary);
        padding: var(--spacing__60) var(--spacing__75);
        border-radius: var(--border__radius);
        outline: none;
        border: none;
        cursor: pointer;
    }

    .button--outlined {
        border: var(--border__weight) solid var(--border__colour);
        background-color: var(--colour--secondary);
        color: var(--colour--primary);
    }

    .button--outlined:hover {
        background-color: var(--colour--primary);
        color: var(--colour--secondary);
    }

    .alert {
        color: var(--colour--error);
        /* padding: var(--spacing__60) var(--spacing__75); */
        /* border-radius: var(--border__radius); */
        margin-bottom: var(--spacing__60);
        font-weight: var(--font__weight--medium);
        /* background-color: var(--colour--error); */
        text-align: center;
        display: none;
    }

    .choice {
        background-color: var(--colour--secondary);
        color: var(--colour--primary);
        padding: var(--spacing__60) var(--spacing__75);
        border: var(--border__weight) solid var(--border__colour);
        border-radius: var(--border__radius);
        display: inline-block;
        outline: none;
        cursor: pointer;
    }

    .choice--active {
        background-color: var(--colour--primary);
        color: var(--colour--secondary);
        font-weight: var(--font__weight--medium);
    }

</style>
