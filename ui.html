<div class="was-plugin layout--column layout--justify height--stretch">
    <div class="was-plugin__body height--stretch">
        <div class="margin__bottom--125">
            <div class="form-label">Target Method</div>
            <div class="form-container">
                <div class="selector" id="target-selector" layout="layout--row layout--justify width--stretch">
                    <div class="highlight target-highlight" style="left: 0px"></div>
                    <div class="selector-item target-selector-item" id="target-key" onclick="selectTargetItem('target-key')">Key</div>
                    <div class="selector-item target-selector-item" id="target-selection" onclick="selectTargetItem('target-selection')">Selection</div>
                </div>
                <input class="input margin__top--60 key-input width--stretch" id="key-input" placeholder="<sprite>" oninput="updateTargetKey(event)">
            </div>
        </div>
        <div class="margin__bottom--125">
            <div class="form-label">Icon Colour</div>
            <div class="form-container">
                <div class="selector" id="colour-selector" layout="layout--row layout--justify width--stretch">
                    <div class="highlight colour-highlight" style="left: 0px"></div>
                    <div class="selector-item colour-selector-item" id="colour-inherit" onclick="selectColourItem('colour-inherit')">Inherit</div>
                    <div class="selector-item colour-selector-item" id="colour-custom" onclick="selectColourItem('colour-custom')">Custom</div>
                </div>
                <input class="input margin__top--60 custom-input width--stretch" id="custom-input" placeholder="#333333" oninput="updateColour(event)">
            </div>
        </div>

        <div class="form-label">Exported SVG Element</div>
        <div class="form-container">
            <textarea placeholder="SVG string" class="textarea width--stretch" id="svg-text"></textarea>
        </div>
    </div>
    <div class="was-plugin__footer">
        <div class="was-plugin__footer-body">
            <div class="alert" id="alert">Message</div>
            <button class="button width--stretch" id="run" onclick="initiateRun()">Run</button>
        </div>
    </div>
</div>

<script>
const TARGET_METHOD = {
    key: 'target-key',
    selection: 'target-selection'
};

const COLOUR_METHOD = {
    inherit: 'colour-inherit',
    custom: 'colour-custom',
};

const ALERT_MESSAGES = {
    [TARGET_METHOD.key]: 'Please provide a key',
    [COLOUR_METHOD.custom]: 'Please provide a colour',
};

const data = {
    target: {
        highlightClass: '.target-highlight',
        selectorClass: '.target-selector-item',
        selectorId: 'target-selector',
        highlightEl: null,
    },
    colour: {
        highlightClass: '.colour-highlight',
        selectorClass: '.colour-selector-item',
        selectorId: 'colour-selector',
        highlightEl: null,
    }
}

const textDecoder = new TextDecoder('utf-8');
const domParser  = new DOMParser();
const colourInherit = 'currentcolor'

let targetMethod = TARGET_METHOD.key;
let colourMethod = COLOUR_METHOD.inherit;
let svgNodeElements = [];
let identifierKey = '';
let colour = colourInherit;
let loading = false;

function getElement(id /* string */) {
    return document.getElementById(id);
}

const runButton = getElement('run');
const alertElement = getElement('alert');

function validate() {
    const validTarget = targetMethod !== TARGET_METHOD.key || !!identifierKey;
    const validColour = colourMethod !== COLOUR_METHOD.custom || !!colour;
    const invalid = !validTarget || !validColour;

    return {
        invalid,
        target: validTarget,
        colour: validColour
    }
}

function showAlert(message /* string */) {
    alertElement.innerHTML = message;
    alertElement.classList.add('visibility--visible');

    setTimeout(() => {
        alertElement.classList.remove('visibility--visible');
    }, 5000)
}

function initiateRun() {
    svgNodeElements = [];

    const {
        target,
        colour,
        invalid
    } = validate();

    if (!!loading) {
        return;
    }

    if (invalid) {
        const message = !target
            ? ALERT_MESSAGES[TARGET_METHOD.key]
            : ALERT_MESSAGES[COLOUR_METHOD.custom];


        return showAlert(message);
    }

    runButton.innerHTML = 'Loading...';
    loading = true;
    parent.postMessage({
        pluginMessage: {
            event: 'run-export',
            identifierKey,
            colour
        }
    }, '*');
}

function updateTargetKey(event /* HTMLevent */) {
    identifierKey = event.srcElement.value;
}

function updateColour(event  /* HTMLevent */) {
    colour = event.srcElement.value;
}

function selectTargetMethod(targetId /* string */) {
    const keyInput = getElement('key-input');
    identifierKey = '';
    targetMethod = targetId;
    keyInput.value = identifierKey;

    targetId === TARGET_METHOD.key
        ? keyInput.classList.add('visibility--visible')
        : keyInput.classList.remove('visibility--visible');
}

function selectColour(colourId /* string */) {
    const customInput = getElement('custom-input');

    colourMethod = colourId;

    if (colourId === COLOUR_METHOD.custom) {
        colour = '';
        customInput.classList.add('visibility--visible');
        return;
    }

    colour = colourInherit;
    customInput.classList.remove('visibility--visible');
}

function prepSpriteElement(encodedSvg /* unit8array */, name /* string */) {
    const decodedText = textDecoder.decode(encodedSvg).replace(/[\n\t]/g, "");
    const splitNode = decodedText.split('><');
    const targetNodeIndex = splitNode.findIndex(item => item.includes('svg'));

    const filteredNode = [...splitNode].filter((item, index) =>
        index > targetNodeIndex
        && index < (splitNode.length - (targetNodeIndex + 1))
    ).map(item => {
        const nodeString = `<${item}>`;

        if (!nodeString.includes('<path')) {
            return nodeString;
        }

        const domEl = domParser.parseFromString(nodeString, "image/svg+xml").documentElement;

        if (!!domEl.getAttribute('fill')) {
            domEl.setAttribute('fill', colour);
        }

        if (!!domEl.getAttribute('fill')) {
            domEl.setAttribute('stroke', colour);
        }

        return domEl.outerHTML;
    });

    const symbolName = name.replace(identifierKey, '').replace(' ', '');

    svgNodeElements.push(`<symbol id="${symbolName}" viewBox="0 0 24 24">${filteredNode.join('')}</symbol>`);
}

function sendSprite() {
    const svgEl = getElement('svg-text');
    const svg = [
        '<svg aria-hidden="true" style="position:absolute;width:0;height:0" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" overflow="hidden"><defs>',
        ...svgNodeElements,
        '</defs></svg>'
    ].join('');

    setTimeout(() => {
        svgEl.value = svgNodeElements.length === 0 ? 'Error' : svg;
        loading = false;
        runButton.innerHTML = 'Run';
    }, 200);
}

onmessage = ({ data }) => {
    const messageData = data.pluginMessage;

    if (messageData.event === 'error') {
        showAlert(messageData.message);
        loading = false;
        runButton.innerHTML = 'Run';
    }

    if (messageData.event === 'prep-sprite-el') {
        prepSpriteElement(messageData.encodedSvg, messageData.name);
    }

    if (messageData.event === 'send-sprite') {
        sendSprite();
    }
}

function addSelectorActiveClass(target) {
    target.classList.add('selector-item--active');
}

function selectTargetItem(id /* string */) {
    const target = document.getElementById(id);
    const items = document.querySelectorAll('.target-selector-item');
    const parent = getElement('target-selector');
    const targetRect = target.getBoundingClientRect();
    const parentRect = parent.getBoundingClientRect();

    items.forEach(el => el.classList.remove('selector-item--active'));

    data.target.highlightEl = document.querySelector('.target-highlight');
    data.target.highlightEl.style.left = `${targetRect.left - parentRect.left}px`;

    addSelectorActiveClass(target);
    setHighlightWidth(target, 'target');
    selectTargetMethod(id);
}

function selectColourItem(id /* string */) {
    const target = document.getElementById(id);
    const items = document.querySelectorAll('.colour-selector-item');
    const parent = getElement('colour-selector');
    const targetRect = target.getBoundingClientRect();
    const parentRect = parent.getBoundingClientRect();

    items.forEach(el => el.classList.remove('selector-item--active'));

    data.colour.highlightEl = document.querySelector('.colour-highlight');
    data.colour.highlightEl.style.left = `${targetRect.left - parentRect.left}px`;

    addSelectorActiveClass(target);
    setHighlightWidth(target, 'colour');
    selectColour(id);
}

function setHighlightWidth(target = null, key) {
    const selectorClass = data[key].selectorClass;
    const highlightClass = data[key].highlightClass;

    const itemTarget = target || document.querySelector(selectorClass);
    const rect = itemTarget.getBoundingClientRect();

    addSelectorActiveClass(itemTarget);

    data[key].highlightEl.style.width = `${rect.width}px`;
}

setTimeout(() => {
    selectTargetItem('target-key');
    selectColourItem('colour-inherit');
}, 0)


</script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap');

    :root {
        --font__family: 'Inter', sans-serif;
        --font__size: 13px;
        --font__weight: 300;
        --font__weight--medium: 400;
        --fond__weight--heavy: 500;

        --spacing__25: 0.25rem;
        --spacing__60: 0.6rem;
        --spacing__75: 0.75rem;
        --spacing__100: 1rem;
        --spacing__125: 1.25rem;

        --border__radius: 8px;
        --border__weight: 1px;
        --border__colour: black;
        --border__colour--light: #E6E6E6;

        --colour--primary: black;
        --colour--secondary: white;
        --colour--placeholder: #CCCCCC;
        --colour--error: #e95858;
    }

    body,
    .input,
    .button,
    .textarea {
        font-family: var(--font__family);
        font-size: var(--font__size);
        font-weight: var(--font__weight);
        margin: 0;
    }


    .was-plugin__body,
    .was-plugin__footer-body {
        padding: var(--spacing__125);
    }

    .was-plugin__body {
        padding-bottom: 6.5rem;
    }

    .was-plugin__footer {
        position: fixed;
        bottom: 0;
        width: 100%;
        background-color: var(--colour--secondary);
        border-top: var(--border__weight) solid var(--border__colour--light);
    }

    .height--stretch {
        height: 100%;
    }

    .width--stretch {
        width: 100%;
    }

    .layout--column {
        display: flex;
        flex-direction: column;
    }

    .layout--row {
        display: flex;
        flex-direction: row;
    }

    .layout--justify {
        justify-content: space-between;
    }

    .layout-body {
        padding: var(--spacing__);
    }

    .layout-footer {
        padding: var(--spacing__100);
        border-top: var(----border__weight) solid var(--colour--placeholder);
    }

    .visibility--visible {
        display: block !important;
    }

    .margin__right--25 {
        margin-right: var(--spacing__25);
    }

    .margin__bottom--25 {
        margin-bottom: var(--spacing__25);
    }

    .margin__top--60 {
        margin-top: var(--spacing__60);
    }

    .margin__bottom--125 {
        margin-bottom: var(--spacing__125);
    }

    .input {
        border: var(--border__weight) solid var(--colour--primary);
        padding: var(--spacing__60);
        border-radius: var(--border__radius);
        outline: none;
        display: none;
        font-size: 12px;
    }

    .input--invalid {
        border-color: var(--colour--error);
    }

    .textarea {
        height: 7rem;
        max-height: 7rem;
        min-height: 7rem;
        border: var(--border__weight) solid var(--colour--primary);
        border-radius: var(--border__radius);
        padding: var(--spacing__75);
        outline: none;
        resize: vertical;
    }

    .input::placeholder,
    .textarea::placeholder {
        color: var(--colour--placeholder);
    }

    .form-label {
        font-weight: var(--fond__weight--heavy);
        margin-bottom: var(--spacing__60);
    }

    .button {
        background-color: var(--colour--primary);
        color: var(--colour--secondary);
        padding: var(--spacing__60);
        border-radius: var(--border__radius);
        outline: none;
        border: none;
        cursor: pointer;
        font-weight: 400;
    }

    .button--outlined {
        border: var(--border__weight) solid var(--border__colour);
        background-color: var(--colour--secondary);
        color: var(--colour--primary);
    }

    .button--outlined:hover {
        background-color: var(--colour--primary);
        color: var(--colour--secondary);
    }

    .alert {
        color: var(--colour--error);
        /* padding: var(--spacing__60) var(--spacing__75); */
        /* border-radius: var(--border__radius); */
        margin-bottom: var(--spacing__60);
        font-weight: var(--font__weight--medium);
        /* background-color: var(--colour--error); */
        text-align: center;
        display: none;
    }

    .form-container {
        background-color: #F2F2F2;
        padding: var(--spacing__60);
        border-radius: 12px;
        position: relative;
    }

    .selector {
        /* padding: 0.25rem; */
        width: 100%;
        border-radius: 12px;
        display: flex;
        position: relative;
    }

    .selector-item {
        white-space: nowrap;
        padding: var(--spacing__60) 1.5rem;
        cursor: pointer;
        z-index: 2;
        text-align: center;
        width: 100%;
        user-select: none;
        transition: color 0.2s ease;
    }

    .selector-item:not(.selector-item--active):hover {
        color: black;
    }

    .selector-item--active {
        font-weight: 400;
        color: white;
    }

    .highlight {
        background-color: black;
        border-radius: 8px;
        position: absolute;
        /* left: 0.25rem; */
        width: 4.75rem;
        height: 2.25rem;
        z-index: 1;
        transition: left 0.2s ease,
                    width 0.2s ease;
    }

</style>
